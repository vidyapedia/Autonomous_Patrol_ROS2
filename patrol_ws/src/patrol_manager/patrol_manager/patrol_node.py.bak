#!/usr/bin/env python3
import math
import time
import rclpy
from rclpy.node import Node
from rclpy.action import ActionClient
from nav2_msgs.action import NavigateToPose
from geometry_msgs.msg import PoseStamped

class PatrolManager(Node):
    def __init__(self):
        super().__init__('patrol_manager')

        self.waypoints = [
            (0.5, 0.0, 0.0),
            (0.5, 0.6, 90.0),
            (0.0, 0.6, 180.0),
            (0.0, 0.0, -90.0),
        ]
        self.i = 0
        self.client = ActionClient(self, NavigateToPose, 'navigate_to_pose')
        self.timer = self.create_timer(1.0, self.tick)
        self.in_flight = False

    def tick(self):
        if self.in_flight:
            return
        if not self.client.wait_for_server(timeout_sec=0.2):
            self.get_logger().info("Waiting for Nav2...")
            return

        x, y, yaw_deg = self.waypoints[self.i]
        goal = NavigateToPose.Goal()
        goal.pose = self.pose(x, y, yaw_deg)

        self.get_logger().info(f"Sending goal {self.i}: {x:.2f},{y:.2f},{yaw_deg:.1f}")
        self.in_flight = True
        send_future = self.client.send_goal_async(goal)
        send_future.add_done_callback(self.on_goal)

    def pose(self, x, y, yaw_deg):
        p = PoseStamped()
        p.header.frame_id = "map"
        p.header.stamp = self.get_clock().now().to_msg()
        p.pose.position.x = float(x)
        p.pose.position.y = float(y)
        yaw = math.radians(float(yaw_deg))
        p.pose.orientation.z = math.sin(yaw/2.0)
        p.pose.orientation.w = math.cos(yaw/2.0)
        return p

    def on_goal(self, future):
        gh = future.result()
        if not gh.accepted:
            self.get_logger().error("Goal rejected")
            self.in_flight = False
            self.i = (self.i + 1) % len(self.waypoints)
            return
        res_future = gh.get_result_async()
        res_future.add_done_callback(self.on_result)

    def on_result(self, future):
        status = future.result().status
        self.get_logger().info(f"Result status: {status}")
        self.in_flight = False
        self.i = (self.i + 1) % len(self.waypoints)

def main():
    rclpy.init()
    rclpy.spin(PatrolManager())
    rclpy.shutdown()

if __name__ == "__main__":
    main()
